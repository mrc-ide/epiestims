---
title: "ccc"
author: "Pierre Nouvellet"
date: "2021-04"
---

```{r options, include = FALSE, message = FALSE, warning = FALSE, error = FALSE}
set.seed(1)
# runif(1,0,1)
library(knitr)
library(EpiEstim)

opts_chunk$set(collapse = TRUE)

opts_chunk$set(fig.path='figs/', fig.keep='high', 
               dev=c('png'), cache=FALSE,
               tidy=FALSE, warning=FALSE, fig.show="asis"
)

```



# simulated data not accounting for variant


```{r}

data_incidence <- readRDS('../simulations/incidence.rds')

SI_sim <- readRDS('../simulations/si.rds') 

target <- readRDS('../simulations/target_Rt.rds')


```

## prepare

```{r}
n_location <- as.integer(4)

I <- data_incidence[,c(1,3,2,4)]

t_window <- 7
t_start <- seq(2, nrow(I)-(t_window-1)) 
t_end <- t_start + (t_window-1)


## prior R
mean_prior <- c(2)
std_prior <- c(1)


```


```{r}

for(i in 1:4){
  
  res <- estimate_R(incid = I[,i], 
                    method = "non_parametric_si", 
                    config = make_config(list(si_distr = SI_sim,
                                              t_start = t_start,
                                              t_end = t_end,
                                              mean_prior = mean_prior,
                                              std_prior = std_prior)))
  
  #plot epiestim
  x_epi <- res$R$t_start # res$R$t_end #(res$R$t_start + res$R$t_end)/2 # 
  plot(x_epi, res$R$`Median(R)`,
       type = 'l',col = 'red3',
       ylim = c(0,4), bty='none',
       xlab = '',ylab = 'R_t')
  polygon(c(x_epi,rev(x_epi)), 
          c(res$R$`Quantile.0.025(R)`,rev(res$R$`Quantile.0.975(R)`)),
          border = NA,col = rgb(1,0,0,.1))
  abline(h = 1, col = 'red3', lty = 2)
  
  # plot target
  lines(1:length(target[[i]]), target[[i]],
        lty = 2,col = 'black')
  
  legend('topright',c('stan','EpiEstim'),lwd=2,
         bty = 'n', col= c('blue3','red3'))
  
  
}
```


---
title: "ccc"
author: "Pierre Nouvellet"
date: "2021-04"
---

```{r options, include = FALSE, message = FALSE, warning = FALSE, error = FALSE}
set.seed(1)
# runif(1,0,1)
library(knitr)
library(EpiEstim)

opts_chunk$set(collapse = TRUE)

opts_chunk$set(fig.path='figs/', fig.keep='high', 
               dev=c('png'), cache=FALSE,
               tidy=FALSE, warning=FALSE, fig.show="asis"
)

```



# simulated data not accounting for variant


```{r}
#data <- readRDS('EpiEstim.rds')
incid <- readRDS('../simulations/incidence.rds')
SI_sim <- readRDS('../simulations/si.rds') 
target <- readRDS('../simulations/target_Rt.rds')

```

# load new package

```{r}

devtools::load_all("../MultiLocEpiEstim/")
?estimate_joint
```

## perform the estimation

```{r joint_estimate}
n_t <- dim(incid)[1]
n_loc <- dim(incid)[2]
n_v <- dim(incid)[3]

priors <- default_priors()

# arbitrary serial interval, same for both variants
w_v <- SI_sim
w <- cbind(w_v, w_v)

system.time( # currently 211s for 3 locations, 100 time steps, 2 variants
  res <- estimate_joint(incid, w, priors,
                        n_iter = 500000,
                        burnin = 5000,
                        thin = 100)
)

```

```{r plot_traces}

epsilon_target <- mean(target[, , 2] / target[, , 1])

par(mfrow = c(3, 4))
plot(res$epsilon, type = "l", xlab = "Iterations", ylab = "Epsilon",
     col = "grey")
abline(h = epsilon_target, col = "red")

t_to_plot <- c(30, 60, 90)
for (t in t_to_plot) {
  for (l in 1:n_loc) {
    plot(res$R[t,l,], , type = "l",
         xlab = "Iterations", ylab = paste("Rt time", t, "location", l),
         col = l)
    abline(h = target[t, l, 1], col = "red")
  }
  if(t != t_to_plot[length(t_to_plot)]) plot.new()
}

```

```{r plot_estimates}
par(mfrow = c(2, 2))
v <- 1

for (l in 1:n_loc) {
  R <- t(apply(res$R[,l,], 1, quantile, c(0.5, 0.025, 0.975), na.rm = TRUE))
  plot(R[, 1], type = "l",
       xlab = "Time", ylab = "R",
       main = paste("R for variant 1, location", l))
  Epi::matshade(1:nrow(R), R)
  lines(target[, l, v], col = "red")
}

boxplot(res$epsilon, ylim = c(0, 2), ylab = "Epsilon", main = "Relative transmissibility of second variant")
abline(h = epsilon_target, col = "red")

```



